{% extends "layout.html" %}
{% block title %}반도체 공정 모니터링 대시보드{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <!-- 왼쪽: 대시보드 제목 -->
        <h2 class="mb-0">실시간 모니터링 현황</h2>

        <!-- 오른쪽: 공지 느낌 안내 문구 -->
        <div class="alert alert-warning py-2 px-3 mb-0" style="font-size: 0.95rem;">
            마지막 설비 점검일: <strong>2024.06.24</strong>
        </div>
    </div>

    <!-- 카드 영역 -->
    <div class="row mb-4">
        {% for key, val in cards.items() %}
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body ">
                        <h5 class="text-muted text-center">{{ key }}</h5>
                        <h1 class="height-100 text-center align-content-center"><strong>{{ val.split(' / ')[0] }}</strong><small class="text-muted text-large"> / {{ val.split(' / ')[1] }}</small></h1>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="card mb-4">
        <div class="card-header">
            <h5>실시간 공정 진행 현황</h5>
        </div>
        <div class="card-body">

            <div class="d-flex justify-content-between flex-wrap">

                <!-- 왼쪽: 공정 흐름 시각화 -->
                <div class="process-flow d-flex">
                    {% for process in ['산화공정', '포토공정<br>(SoftBake)', '포토공정<br>(Lithography)', '식각공정', '증착공정'] %}
                        <div class="stage text-center me-3">
                            <div class="stage-header fw-bold mb-2">{{ process|safe }}</div>
                            <div class="chamber-list d-flex flex-column gap-2">
                                {% for chamber in [1, 2, 3] %}
                                    <div class="chamber {{ process_status[process][chamber - 1] }}">{{ chamber }}</div>
                                {% endfor %}
                            </div>
                        </div>
                        {% if not loop.last %}
                            <div class="arrow align-self-center me-3 fs-4 text-muted">→</div>
                        {% endif %}
                    {% endfor %}
                </div>

                <!-- 오른쪽: 현재 작업 정보 -->
                <div class="current-job-info" style="margin-right: 30px;">
                    <h6 class="fw-bold mb-3">현재 작업 정보</h6>
                    <table class="table table-sm table-bordered text-center mb-3">
                        <tbody>
                        <tr>
                            <th class="table-secondary">작업 일자</th>
                            <td>2024-06-30</td>
                        </tr>
                        <tr>
                            <th class="table-secondary">Lot 번호</th>
                            <td>8</td>
                        </tr>
                        </tbody>
                    </table>
                    <h6 class="fw-semibold">공정 스케줄링</h6>
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-light">
                        <tr>
                            <th>경로</th>
                            <th>산화</th>
                            <th>포토-S</th>
                            <th>포토-L</th>
                            <th>식각</th>
                            <th>증착</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr><td class="table-light">A</td><td>2</td><td>3</td><td>2</td><td>2</td><td>2</td></tr>
                        <tr><td class="table-light">B</td><td>3</td><td>1</td><td>1</td><td>1</td><td>1</td></tr>
                        <tr><td class="table-light">C</td><td>1</td><td>2</td><td>3</td><td>3</td><td>3</td></tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>
    <!-- 일주일 불량률 추이 + 월별 부하 -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>일주일 단위 불량률 추이</h5>
                </div>
                <div class="card-body">

                    <canvas id="defectChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>월별 부하 (Route 기준)</h5>
                </div>
                <div class="card-body">

                    <canvas id="routeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="row mb-4">
        <!-- 경로별 불량률 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>경로별 불량률 (총 경로: {{ route_defect_table|length }}개)</h5>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="thead-light">
                        <tr>
                            <th>Rank</th>
                            <th>경로</th>
                            <th>불량률(%)</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for i, row in route_defect_table.iterrows() %}
                            <tr>
                                <td>{{ i + 1 }}</td>
                                <td>{{ row['Route5'] }}</td>
                                <td>{{ '%.2f'|format(row['DefectRate']) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 투입경로별 불량률 -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5>투입경로별 불량률 (총 투입 경로: {{ combo_defect_table|length }}개)</h5>
                </div>
                <div class="card-body overflow-auto" style="max-height: 300px;">
                    <table class="table table-sm table-bordered text-center">
                        <thead class="thead-light">
                        <tr>
                            <th>Rank</th>
                            <th>투입경로</th>
                            <th>불량률(%)</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for i, row in combo_defect_table.iterrows() %}
                            <tr>
                                <td>{{ row['Rank'] }}</td>
                                <td>{{ row['투입경로'] }}</td>
                                <td>{{ '%.2f'|format(row['불량률(%)']) }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="card mt-4">
        <div class="card-header">
            <h4>프로세스 관리도 (C)</h4>
        </div>
        <div class="card-body">
            <canvas id="cChart" height="120"></canvas>
        </div>
    </div>
    <!-- 최근 공정 결과 테이블 -->
    <div class="card">
        <div class="card-header">
            <div class="d-flex justify-content-between align-items-center mb-2">

                <!-- 왼쪽: 제목 -->
                <div>
                    <h4 class="mb-0">최근 공정 진행 결과</h4>
                </div>

                <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#conditionModal">
                        영향인자 기준 보기
                    </button>
                    <select id="defectFilter" class="form-select" style="width: 200px;">
                        <option value="all">전체 보기</option>
                        <option value="non-defect">양품만 보기</option>
                        <option value="defect">불량만 보기</option>
                    </select>


                </div>

            </div>
        </div>

        <div class="card-body overflow-auto" style="max-height: 600px;">
            <!-- 영향인자 기준 모달 -->
            <div class="modal fade" id="conditionModal" tabindex="-1" aria-labelledby="conditionModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-xl modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="conditionModalLabel">운전 파라미터 최적 운전 조건표</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="닫기"></button>
                        </div>
                        <div class="modal-body">
                            <!-- 실제 표 -->
                            <div class="table-responsive">
                                <table class="table table-bordered text-center">
                                    <thead class="table-dark" >
                                    <tr>
                                        <th style="color:black !important;">공정명</th>
                                        <th style="color:black !important;">영향인자</th>
                                        <th style="color:black !important;">최적운전조건</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr><td rowspan="2">산화공정</td><td>건식 산화온도(℃)</td><td>1275 ≤ Temp_Oxide ≤ 1348</td></tr>
                                    <tr><td>가스 농도(ppm)</td><td>20.75 ≤ ppm ≤ 28.17 / 46.07 ≤ ppm ≤ 50.06</td></tr>

                                    <tr><td rowspan="4">포토공정 (soft_bake)</td><td>PR 흡착시 온도(℃)</td><td>86.23 ≤ temp_softbake ≤ 88.36 / 95.48 ≤ temp_softbake ≤ 96.77</td></tr>
                                    <tr><td>N₂ 산화물 흡착 온도(℃)</td><td>190.93 ≤ temp_HMDS_bake ≤ 68.75 / 72.97 ≤ temp_HMDS_bake ≤ 73.34</td></tr>
                                    <tr><td>1차 스핀 속도 (rpm)</td><td>5012 ≤ spin1 ≤ 5028 / 5563 ≤ spin1 ≤ 5694</td></tr>
                                    <tr><td>3차 스핀 속도 (rpm)</td><td>12.41 ≤ spin3 ≤ 16.50 / 47.45 ≤ spin3 ≤ 61.88</td></tr>

                                    <tr><td rowspan="1">포토공정 (lithography)</td><td>노광 에너지(mJ/cm²)</td><td>111.702 ≤ Energy_Exposure ≤ 112.223</td></tr>

                                    <tr><td rowspan="2">식각공정</td><td>막 두께(nm)</td><td>13 ≤ Thin_F4_etch ≤ 151 / 680 ≤ Thin_F4_etch ≤ 687</td></tr>
                                    <tr><td>식각속도(nm/min)</td><td>5012 ≤ Etching_rate ≤ 5028 / 5563 ≤ Etching_rate ≤ 5694</td></tr>

                                    <tr><td rowspan="2">이온주입</td><td>이온량</td><td>1.2 × 10¹⁸ ≤ Flux160s ≤ 1.4 × 10¹⁸</td></tr>
                                    <tr><td>플라즈마 에너지</td><td>32773 ≤ input_Energy ≤ 33675 / 29604 ≤ input_Energy ≤ 30152</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="table-responsive">
                <table id="processTable" class="table table-bordered table-custom">
                    <thead>
                    <tr class="text-center">
                        <th>#</th>
                        <th>결과</th>
                        <th>Route</th>
                        <th>Target</th>
                        <th>Wafer_Num</th>
                        <th>Lot_Num</th>
                        {% for key in process_table[0].params.keys() %}<th>{{ key }}</th>{% endfor %}
                        <th>Datetime</th>


                    </tr>
                    </thead>
                    <tbody>
                    {% for row in process_table %}
                        <tr data-defect="{{ 'yes' if row.is_defect else 'no' }}">
                            <td class="text-center">{{ loop.index }}</td>
                            <td class="text-center">
                                <span class="circle {% if row.is_defect %}defect-yes{% else %}defect-no{% endif %}"></span>
                            </td>
                            <td>{{ row.Route }}</td>
                            <td>{{ row.Target }}</td>
                            <td>{{ row.Wafer_Num }}</td>
                            <td>{{ row.Lot_Num }}</td>
                            {% for key, val in row.params.items() %}
                                <td class="{% if row.is_defect and val.highlight %}highlight-red{% endif %}">{{ val.value }}</td>                        {% endfor %}
                            <td>{{ row.Datetime }}</td>

                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const defectCtx = document.getElementById('defectChart').getContext('2d');
    new Chart(defectCtx, {
        type: 'line',
        data: {
            labels: {{ defectRateData['Datetime'][:10].tolist()|tojson }},
            datasets: [{
                label: '불량률 (%)',
                data: {{ defectRateData['defect_rate'].tolist()|tojson }},
                borderColor: 'rgba(75, 192, 192, 1)',
                pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                fill: false,
                tension: 0.2
            }]
        }
    });

    const routeCtx = document.getElementById('routeChart').getContext('2d');
    new Chart(routeCtx, {
        type: 'bar',
        data: {
            labels: {{ loadByRouteData['Route'].tolist()|tojson }},
            datasets: [{
                label: '생산량',
                data: {{ loadByRouteData['count'].tolist()|tojson }},
                backgroundColor: 'rgba(153, 102, 255, 0.6)'
            }]
        }
    });

    const cChartData = {{ c_chart_data | tojson }};
    const ctxC = document.getElementById('cChart').getContext('2d');

    new Chart(ctxC, {
        type: 'line',
        data: {
            labels: cChartData.index,
            datasets: [
                {
                    label: 'Target',
                    data: cChartData.target,
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: cChartData.out_of_control.map(flag => flag ? 'rgba(255, 99, 132, 1)' : 'rgba(54, 162, 235, 1)'),
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    fill: false,
                    tension: 0.2
                },
                {
                    label: 'UCL',
                    data: cChartData.ucl,
                    borderColor: 'red',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'Center',
                    data: cChartData.center,
                    borderColor: 'green',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                },
                {
                    label: 'LCL',
                    data: cChartData.lcl,
                    borderColor: 'blue',
                    borderDash: [5, 5],
                    pointRadius: 0,
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                tooltip: { enabled: true }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    title: { display: true, text: 'Target (결함 수)' }
                },
                x: {
                    title: { display: true, text: 'Index (생산 순서)' }
                }
            }
        }
    });

    document.getElementById('defectFilter').addEventListener('change', function () {
        const value = this.value;
        const table = document.getElementById('processTable');
        const rows = table.querySelectorAll('tbody tr'); // 이제 이 테이블만 대상으로!

        rows.forEach(row => {
            const isDefect = row.getAttribute('data-defect'); // 'yes' or 'no'
            if (value === 'all') {
                row.style.display = '';
            } else if (value === 'defect' && isDefect === 'yes') {
                row.style.display = '';
            } else if (value === 'non-defect' && isDefect === 'no') {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    });
</script>

{% endblock %}
